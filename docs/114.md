# ä»‹ç»

> åŸæ–‡:[https://github . com/fig ment-networks/learn-tutorials/blob/master/polkadot/runtime-upgrade . MD](https://github.com/figment-networks/learn-tutorials/blob/master/polkadot/runtime-upgrade.md)

åŒºå—é“¾çš„åˆ†æƒæœ‰ä¼˜ç‚¹ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªä¸»è¦ä¼˜ç‚¹æ˜¯æ²¡æœ‰ä¸€ä¸ªå•ä¸€çš„å•ä½å¯¹ä¸€ä¸ªç³»ç»Ÿæ‹¥æœ‰å®Œå…¨çš„æƒåŠ›ã€‚å¦ä¸€æ–¹é¢ï¼Œç¼ºç‚¹æ˜¯åœ¨æ²¡æœ‰é›†ä¸­æ§åˆ¶çš„ç¯å¢ƒä¸­ï¼Œå‡çº§å¾ˆéš¾ï¼Œå› ä¸ºéœ€è¦åŒæ—¶åè°ƒè¿™ä¹ˆå¤šèŠ‚ç‚¹ã€‚å‡çº§åŒºå—é“¾çš„ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„è§£å†³æ–¹æ¡ˆæ˜¯æ‰€è°“çš„â€œç¡¬åˆ†å‰â€ï¼Œç„¶è€Œè¿™æœ‰è®¸å¤šæ½œåœ¨çš„æ”»å‡»åª’ä»‹ï¼Œå¹¶ä¸”å¾ˆéš¾åè°ƒã€‚

åŸºäºåº•å±‚æ¡†æ¶å‡çº§åˆ†æ•£ç³»ç»Ÿçš„æœ€æ–°è§£å†³æ–¹æ¡ˆå«åš`runtime-upgrade`ã€‚è¯¥è§£å†³æ–¹æ¡ˆå·¥ä½œé¡ºåˆ©ï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•è½»æ¾å‡çº§æ‚¨çš„åŸºæ¿é“¾ã€‚æˆ‘ä»¬å°†ç ”ç©¶é€‚åº”æ€§æ˜¯å¦‚ä½•åœ¨åº•å±‚æ¡†æ¶ä¸­å®ç°çš„ã€‚

# å…ˆå†³æ¡ä»¶

ä¸ºäº†æˆåŠŸåœ°å­¦ä¹ æœ¬æ•™ç¨‹ï¼Œæ‚¨åº”è¯¥å¯¹ Rust ç¼–ç¨‹è¯­è¨€å’Œ Polkadot çš„åº•å±‚æ¡†æ¶æœ‰ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ã€‚

# å…¥é—¨æŒ‡å—

[![](../Images/9ea430c1b0c435843a893c4fe404331d.png)T2ã€‘](https://github.com/figment-networks/learn-tutorials/raw/master/assets/runtime-upgrade.png)

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é€æ­¥å®Œæˆä»¥ä¸‹æ­¥éª¤:

1.  æ„å»ºæœ€ç®€å•çš„åŸºäºè¡¬åº•çš„åŒºå—é“¾
2.  æœ¬åœ°è¿è¡Œåº•ç‰©é“¾(åœ¨æ‚¨è‡ªå·±çš„ç¡¬ä»¶ä¸Š)
3.  å‘è¿è¡Œæ—¶æ·»åŠ æ–°åŠŸèƒ½
4.  ç”Ÿæˆ WebAssembly (WASM)æ–‡ä»¶
5.  é€šè¿‡æ£€æŸ¥ç‰ˆæœ¬æ¥éªŒè¯å‡çº§

å‡çº§è¿è¡Œæ—¶çŠ¶æ€è½¬æ¢åŠŸèƒ½åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤:

*   æå‡(å¢åŠ )è§„èŒƒç‰ˆæœ¬
*   å»ºç«‹ WASM æ–‡ä»¶:`WASM_TARGET_DIRECTORY="$(pwd)" cargo build`
*   ä½¿ç”¨`sudo`å‘½ä»¤å¯åŠ¨è¿è¡Œæ—¶

# å»ºé€ ä¸€ä¸ªç®€å•çš„åŒºå—é“¾

æ£€æŸ¥[https://github . com/TomaszWaszczyk/substrate-runtime-upgrade-tutorial](https://github.com/TomaszWaszczyk/substrate-runtime-upgrade-tutorial)çš„ä¸»åˆ†æ”¯ï¼Œç„¶åæ‰§è¡Œ make init å‘½ä»¤ï¼Œå¤§çº¦ 10 åˆ†é’Ÿå(å–å†³äºæ‚¨çš„æœºå™¨çš„æ€§èƒ½),æ‚¨åº”è¯¥ä¼šçœ‹åˆ°å¦‚ä¸‹å†…å®¹:

```
Compiling sc-finality-grandpa v0.8.0
Compiling rocksdb v0.15.0
Compiling kvdb-rocksdb v0.9.1
Compiling sc-client-db v0.8.0
Compiling sc-service v0.8.0
Compiling sc-cli v0.8.0
Compiling frame-benchmarking-cli v2.0.0
Finished dev [unoptimized + debuginfo] target(s) in 13m 01s 
```

> æ³¨æ„:å¦‚æœæ‚¨æƒ³è¦æ„å»ºé¡¹ç›®çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œè¯·æ‰§è¡Œ`cargo build --release`

# åœ¨æœ¬åœ°è¿è¡ŒåŸºåº•èŠ‚ç‚¹

ä½¿ç”¨`make run`å‘½ä»¤:

```
Running `target/debug/node-template --dev -lruntime=debug`
Sep 29 18:18:09.106  WARN Running in --dev mode, RPC CORS has been disabled.    
Sep 29 18:18:09.106  INFO Substrate Node    
Sep 29 18:18:09.106  INFO âœŒï¸  version 2.0.0-73d7748-x86_64-linux-gnu    
Sep 29 18:18:09.106  INFO â¤ï¸  by Substrate DevHub <https://github.com/substrate-developer-hub>, 2017-2021    
Sep 29 18:18:09.106  INFO ğŸ“‹ Chain specification: Development    
Sep 29 18:18:09.106  INFO ğŸ·  Node name: frantic-insect-7496    
Sep 29 18:18:09.106  INFO ğŸ‘¤ Role: AUTHORITY    
Sep 29 18:18:09.107  INFO ğŸ’¾ Database: RocksDb at /home/tomek/.local/share/node-template/chains/dev/db    
Sep 29 18:18:09.107  INFO â›“  Native runtime: node-template-1 (node-template-1.tx1.au1)    
Sep 29 18:18:10.070  INFO ğŸ”¨ Initializing Genesis block/state (state: 0x0f2aâ€¦c2cc, header-hash: 0x1e1dâ€¦f017)    
Sep 29 18:18:10.073  INFO ğŸ‘´ Loading GRANDPA authority set from genesis on what appears to be first startup.    
Sep 29 18:18:10.294  INFO â±  Loaded block-time = 2000 milliseconds from genesis on first-launch    
Sep 29 18:18:10.295  WARN Using default protocol ID "sup" because none is configured in the chain specs    
Sep 29 18:18:10.296  INFO ğŸ·  Local node identity is: 12D3KooWNo1348XGxpiA9uFJn4GJdptp7NcX72pFXsGZXghPKLYa (legacy representation: 12D3KooWNo1348XGxpiA9uFJn4GJdptp7NcX72pFXsGZXghPKLYa)    
Sep 29 18:18:10.618  INFO ğŸ“¦ Highest known block at #0    
Sep 29 18:18:10.620  INFO ã€½ï¸ Prometheus server started at 127.0.0.1:9615    
Sep 29 18:18:10.624  INFO Listening for new connections on 127.0.0.1:9944\.    
Sep 29 18:18:12.249  INFO ğŸ™Œ Starting consensus session on top of parent 0x1e1dd820c46a22dbd297afd5a62e73511208bafe64c6dc9e6a171562c443f017    
Sep 29 18:18:12.397  INFO ğŸ Prepared block for proposing at 1 [hash: 0x3b7c2d4f453358a70095cc0ad55a5f157a5be3d145c42213ea88c419b48966bf; parent_hash: 0x1e1dâ€¦f017; extrinsics (1): [0xff0fâ€¦0d06]]    
Sep 29 18:18:12.515  INFO ğŸ”– Pre-sealed block for proposal at 1\. Hash now 0xc61a8f6ea035c0fd2e8acef986a60ec92abbaaa1f30c4781603d4ec83591b216, previously 0x3b7c2d4f453358a70095cc0ad55a5f157a5be3d145c42213ea88c419b48966bf.    
Sep 29 18:18:12.517  INFO âœ¨ Imported #1 (0xc61aâ€¦b216)    
Sep 29 18:18:14.123  INFO ğŸ™Œ Starting consensus session on top of parent 0xc61a8f6ea035c0fd2e8acef986a60ec92abbaaa1f30c4781603d4ec83591b216 
```

é€šè¿‡[https://polkadot.js.org/apps/#/extrinsics?è®¿é—®æœ¬åœ°èŠ‚ç‚¹å‰ç«¯ rpc=ws://127.0.0.1:9944](https://polkadot.js.org/apps/#/extrinsics?rpc=ws://127.0.0.1:9944)

[![](../Images/b0830dfdc3fa82fcf45029e923f6d2a8.png)T2ã€‘](https://github.com/figment-networks/learn-tutorials/raw/master/assets/before-upgrade.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° kitties æ‰˜ç›˜åªæœ‰ä¸€ä¸ª create()å‡½æ•°ï¼Œå®ƒæ˜¯æˆ‘ä»¬åœ¨è¿è¡Œæ—¶çš„å½“å‰çŠ¶æ€è½¬æ¢å‡½æ•°ã€‚ä¸ºäº†æ¼”ç¤ºåŸºäºåº•ç‰©çš„åŒºå—é“¾çš„é€‚åº”æ€§æœ‰å¤šå¼ºï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°ç‰¹æ€§ breed()å‡½æ•°ã€‚

# å‘è¿è¡Œæ—¶æ·»åŠ åŠŸèƒ½

åœ¨è¿›è¡Œå‡çº§ä¹‹å‰ï¼Œspec_version åº”ä¸º 1ã€‚ç°åœ¨æˆ‘ä»¬æ­£åœ¨è¿›è¡Œå‡çº§ï¼Œæˆ‘ä»¬å·²ç»å¢åŠ äº†å­—æ®µï¼Œå› æ­¤å®ƒç°åœ¨å°†æ˜¯ 2ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
pub const VERSION: RuntimeVersion = RuntimeVersion {
	spec_name: create_runtime_str!("node-template"),
	impl_name: create_runtime_str!("node-template"),
	authoring_version: 1,
	spec_version: 2, // incremented version
	impl_version: 1,
	apis: RUNTIME_API_VERSIONS,
	transaction_version: 1,
};
```

æˆ‘ä»¬çš„å‡çº§å°†ä¸º kitties æ‰˜ç›˜æ·»åŠ ä¸€ä¸ªåä¸º`breed`çš„æ–°åŠŸèƒ½ï¼Œå®ç°å¦‚ä¸‹:

```
/// Breed kitties
#[weight = 1000]
pub fn breed(origin, kitty_id_1: u32, kitty_id_2: u32) {
  let sender = ensure_signed(origin)?;
  let kitty1 = Self::kitties(&sender, kitty_id_1).ok_or(Error::<T>::InvalidKittyId)?;
  let kitty2 = Self::kitties(&sender, kitty_id_2).ok_or(Error::<T>::InvalidKittyId)?;

  ensure!(kitty1.gender() != kitty2.gender(), Error::<T>::SameGender);

  let kitty_id = Self::get_next_kitty_id()?;

  let kitty1_dna = kitty1.0;
  let kitty2_dna = kitty2.0;

  let selector = Self::random_value(&sender);
  let mut new_dna = [0u8; 16];

  // Combine parents and selector to create new kitty
  for i in 0..kitty1_dna.len() {
    new_dna[i] = combine_dna(kitty1_dna[i], kitty2_dna[i], selector[i]);
  }

  let new_kitty = Kitty(new_dna);

  Kitties::<T>::insert(&sender, kitty_id, &new_kitty);
  Self::deposit_event(RawEvent::KittyBred(sender, kitty_id, new_kitty));
}
```

åœ¨å°†è¿™ä¸ªå“ç§åŠŸèƒ½æ·»åŠ åˆ° kitties æ‰˜ç›˜ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ„å»º WASM æ–‡ä»¶ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå…¨æ–°å®ç°çš„é“¾æ¥:[https://github . com/TomaszWaszczyk/substrate-runtime-upgrade-tutorial/blob/after-runtime-upgrade/Pallas/kitties/src/lib . RS](https://github.com/TomaszWaszczyk/substrate-runtime-upgrade-tutorial/blob/after-runtime-upgrade/pallets/kitties/src/lib.rs)

æ‰§è¡Œå‡çº§åï¼Œæˆ‘ä»¬é¢„è®¡ kitties æ‰˜ç›˜å°†åŒ…å«æ–°çš„`breed`åŠŸèƒ½ï¼Œè€Œæ— éœ€é‡å¯æ­£åœ¨è¿è¡Œçš„åŸºæ¿èŠ‚ç‚¹ã€‚åŒºå—é“¾çš„çœŸæ­£é€‚åº”æ€§ï¼

# æ„å»ºè¿è¡Œæ—¶ WASM æ–‡ä»¶

è¿è¡Œç»ˆç«¯å‘½ä»¤`WASM_TARGET_DIRECTORY="$(pwd)" cargo build`ä»¥æ„å»ºè¿è¡Œæ—¶ WASM æ–‡ä»¶ã€‚

åœ¨æˆåŠŸæ„å»ºä¹‹åï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å½“å‰ç›®å½•ä¸­æœ‰ä¸€ä¸ªæ–°æ–‡ä»¶:

[![](../Images/ac1e92948a5374288790af6a6cb7d15a.png)T2ã€‘](https://github.com/figment-networks/learn-tutorials/raw/master/assets/wasm.png)

# å‡çº§è¿è¡Œæ—¶

æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿è¡Œç‰ˆæœ¬ 1 çš„åº•å±‚èŠ‚ç‚¹ï¼Œå¸Œæœ›å°†è¿è¡Œæ—¶å‡çº§åˆ°ç‰ˆæœ¬ 2ã€‚æˆåŠŸå‡çº§çš„è¯æ˜å°†æ˜¯æˆ‘ä»¬æ–°å¢åŠ çš„å“ç§åŠŸèƒ½ã€‚è®©æˆ‘ä»¬ç”¨å‰ç«¯æ£€æŸ¥ä¸€ä¸‹ã€‚

è¦æ‰§è¡Œå‡çº§ï¼Œè¯·è½¬åˆ°**å¼€å‘è€…**é€‰é¡¹å¡ï¼Œç„¶åé€‰æ‹© **Sudo** ã€‚ç¡®ä¿æ‚¨å·²ç»é€‰æ‹©äº†`system`æ‰˜ç›˜å’Œ`setCode(code)`ï¼Œæ£€å…¥`file upload`ï¼Œå¹¶é€‰æ‹©ä¸Šä¸€æ­¥ä¸­æ–°åˆ›å»ºçš„ WASM æ–‡ä»¶:`node_template_runtime.wasm`ã€‚æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æƒé‡è¦†ç›–æ£€æŸ¥**ï¼Œå¹¶åœ¨**å­—æ®µä¸­ä¸ºè¯¥è°ƒç”¨**è¾“å…¥ä¸€ä¸ªå€¼ï¼Œä¾‹å¦‚ 100ã€‚è¦ç¡®è®¤å‡çº§ï¼Œç‚¹å‡»**æäº¤æœªé€‰ä¸­çš„ Sudo**ã€‚**

[![](../Images/f3b80d48d44bdaa9d15e5007b8924a26.png)T2ã€‘](https://github.com/figment-networks/learn-tutorials/raw/master/assets/upgrade.png)

æˆåŠŸå‡çº§åï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ›´æ–°åçš„`spec_version`,å¹¶å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„æ–°åŠŸèƒ½:

[![](../Images/ca9b4b12b77a417f6d7ab4d44b65e736.png)T2ã€‘](https://github.com/figment-networks/learn-tutorials/raw/master/assets/after-upgrade.png)

åœ¨ä¸Šé¢çš„æˆªå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆåŠŸå‡çº§çš„ç»“æœã€‚è¯·æ³¨æ„ï¼Œ`spec_version`å·²ç»å¢åŠ åˆ° 2(è¿™é‡Œè¡¨ç¤ºâ€œèŠ‚ç‚¹æ¨¡æ¿/2â€)ã€‚

# è§£å†³çº·äº‰

## é—®é¢˜:æ„å»ºæ—¶å‡ºç°ç”Ÿé”ˆé”™è¯¯

æ‚¨å¯èƒ½ä¼šåœ¨æ„å»ºæ—¶é‡åˆ°é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚è¿™æ„å‘³ç€æ‚¨æ²¡æœ‰å®‰è£… Rust çš„æ­£ç¡®ç‰ˆæœ¬ã€‚

```
 Compiling prost-derive v0.6.1
error[E0034]: multiple applicable items in scope
   --> /home/tomek/.cargo/registry/src/github.com-1ecc6299db9ec823/prost-derive-0.6.1/src/lib.rs:111:14
    |
111 |             .intersperse(quote!(|));
    |              ^^^^^^^^^^^ multiple `intersperse` found
    |
    = note: candidate #1 is defined in an impl of the trait `Iterator` for the type `Map<I, F>`
    = note: candidate #2 is defined in an impl of the trait `Itertools` for the type `T`
help: disambiguate the associated function for candidate #1
    |
107 ~         let tags = Iterator::intersperse(field
108 +             .tags()
109 +             .into_iter()
110 +             .map(|tag| quote!(#tag)), {
111 +         let mut _s = $crate::__private::TokenStream::new();
112 +         $crate::quote_each_token!(_s $($tt)*);
  ...
help: disambiguate the associated function for candidate #2
    |
107 ~         let tags = Itertools::intersperse(field
108 +             .tags()
109 +             .into_iter()
110 +             .map(|tag| quote!(#tag)), {
111 +         let mut _s = $crate::__private::TokenStream::new();
112 +         $crate::quote_each_token!(_s $($tt)*);
  ...

For more information about this error, try `rustc --explain E0034`.
   Compiling asn1_der_derive v0.1.2
error: could not compile `prost-derive` due to previous error
warning: build failed, waiting for other jobs to finish...
error: build failed
make: *** [Makefile:11: build-full] Error 101 
```

è§£å†³æ–¹æ¡ˆ-åœ¨æ‚¨çš„æœºå™¨ä¸Šé…ç½®å¹¶é»˜è®¤æ­£ç¡®ç‰ˆæœ¬çš„ Rust è¯­è¨€

æ‚¨éœ€è¦å®‰è£…å¹¶é»˜è®¤è®¾ç½® Rust: `rustup update nightly-2020-08-23` Rust è¯­è¨€çš„æŒ‡å®šå¤œé—´ç‰ˆæœ¬

1.  è£…ç½®

`rustup update nightly-2020-08-23`

2.  è®¾ä¸ºé»˜è®¤ç‰ˆæœ¬

`rustup default nightly-2020-08-23-x86_64-unknown-linux-gnu`

3.  æ£€æŸ¥é»˜è®¤ç‰ˆæœ¬

åœ¨è¾“å‡ºä¸­ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```
active toolchain
----------------

nightly-2020-08-23-x86_64-unknown-linux-gnu (default)
rustc 1.47.0-nightly (663d2f5cd 2020-08-22) 
```

# ç»“è®º

æ­å–œä½ ï¼ä½ å·²ç»ç†è§£äº†é€‚åº”æ€§åœ¨åˆ†æ•£åŒ–çš„åŒºå—é“¾ä¸­çš„é‡è¦æ€§ï¼Œä»¥åŠè¿™ç§ç‰¹æ€§æ˜¯å¦‚ä½•åœ¨ Substrate æ¡†æ¶ä¸­å®ç°çš„ã€‚

åœ¨é˜…è¯»æœ¬æ•™ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæ‚¨å·²ç»å­¦ä¹ äº† Rust è¯­è¨€çš„åŸºç¡€çŸ¥è¯†ï¼Œå¦‚ä½•ç¼–è¯‘åŸºäºè¡¬åº•çš„é“¾ï¼Œä»¥åŠå¦‚ä½•ç”Ÿæˆ wasm æ–‡ä»¶å¹¶ä¸Šä¼ ï¼Œä»¥ä¾¿ä¸ºé“¾æä¾›æ–°åŠŸèƒ½ã€‚

# å…³äºä½œè€…

è¯¥æ•™ç¨‹ç”± Tomasz Waszczyk åˆ›å»ºã€‚å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œæ‚¨å¯ä»¥åœ¨ [Github](https://github.com/tomaszwaszczyk) ä¸Šè”ç³» Tomaszï¼Œå¯»æ±‚å¸®åŠ©æˆ–è§£é‡Šä¸æ³¢å°”å¡å¤šç‰¹/è‰é—´å¼¥ç”Ÿç”Ÿæ€ç³»ç»Ÿå’Œæœ¬æŒ‡å—ç›¸å…³çš„ç–‘é—®ã€‚

# å‚è€ƒ

å½“æ‚¨å®Œæˆæœ¬æ•™ç¨‹åï¼Œæ‚¨å°±å¯ä»¥è¿›ä¸€æ­¥äº†è§£ Jimmy Chu çš„ [Forkless å‡çº§è¿è¡Œæ—¶](https://substrate.dev/docs/en/tutorials/forkless-upgrade/)æ•™ç¨‹ã€‚