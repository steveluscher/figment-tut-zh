# ä»‹ç»

> åŸæ–‡ï¼š<https://github.com/figment-networks/learn-tutorials/blob/master/near/write-and-deploy-a-smart-contract-on-near.md>

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Rust ç¼–å†™å¹¶æµ‹è¯•ä¸€ä¸ªæ™ºèƒ½åˆçº¦ã€‚ç„¶åæˆ‘ä»¬å°†å®ƒéƒ¨ç½²åˆ° Testnet é™„è¿‘ã€‚

ä¸ºä»€ä¹ˆç”Ÿé”ˆï¼ŸRust æ˜¯åœ¨ NEAR ä¸Šç¼–å†™æ™ºèƒ½åˆåŒçš„é¦–é€‰ç¼–ç¨‹è¯­è¨€ã€‚Rust æä¾›äº†è®¸å¤šç‰¹æ€§ï¼Œå¦‚å†…å­˜å®‰å…¨ã€è¿è¡Œæ—¶é—´çŸ­ç­‰ã€‚è¿™å…è®¸æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ™ºèƒ½å¥‘çº¦ï¼Œå®ƒæ²¡æœ‰å†…å­˜é”™è¯¯ï¼Œå¹¶ä¸”åœ¨åŒºå—é“¾ä¸Šæ¶ˆè€—æ›´å°‘çš„å­˜å‚¨ã€‚

# å…ˆå†³æ¡ä»¶

è¯·ç¡®ä¿æ‚¨å·²å®Œæˆè·¯å¾„é™„è¿‘çš„[ã€‚è¯¥é€”å¾„æ¶µç›–äº†è¿‘æœŸå‘å±•çš„åŸºç¡€ã€‚](https://learn.figment.io/pathways/near-pathway)

# è¦æ±‚

æ‚¨åº”è¯¥å®‰è£…ä»¥ä¸‹è¦æ±‚:

*   ç”Ÿé”ˆ(å®‰è£…[æŒ‡å—](https://www.rust-lang.org/tools/install)å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºç”Ÿé”ˆçš„çŸ¥è¯†ï¼ŒæŸ¥çœ‹æœ¬æŒ‡å—[è¿™é‡Œ](https://doc.rust-lang.org/book/)
*   CLI é™„è¿‘(å®‰è£…[æŒ‡å—](https://www.npmjs.com/package/near-cli)
*   é è¿‘ testnet å¸æˆ·(å¦‚æœæ‚¨æ²¡æœ‰ Testnet å¸æˆ·ï¼Œè¯·æŸ¥çœ‹æœ¬æŒ‡å—[æ­¤å¤„](https://nearhelp.zendesk.com/hc/en-us/articles/1500002248242-Creating-a-NEAR-Wallet-account)

# è®¾ç½®

è¦è®¾ç½®æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæˆ‘ä»¬éœ€è¦å°† WASM (WebAssembly)ç›®æ ‡æ·»åŠ åˆ°å·¥å…·é“¾ä¸­ã€‚è¦æ·»åŠ ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
rustup target add wasm32-unknown-unknown 
```

ç»ˆç«¯ä¸­çš„è¾“å‡ºå°†æ˜¯:

```
info: downloading component 'rust-std' for 'wasm32-unknown-unknown'
info: installing component 'rust-std' for 'wasm32-unknown-unknown'
info: using up to 500.0 MiB of RAM to unpack components 13.9 MiB /  13.9 MiB (100 %)  10.0 MiB/s in  1s ETA:  0s 
```

å¦‚æœå·²ç»æ·»åŠ äº†ç›®æ ‡ï¼Œé‚£ä¹ˆç»ˆç«¯ä¸­çš„è¾“å‡ºå°†æ˜¯:

```
info: component 'rust-std' for target 'wasm32-unknown-unknown' is up to date 
```

ä»€ä¹ˆæ˜¯ Rust toolchainï¼Ÿå·¥å…·é“¾æ˜¯ç¼–è¯‘ Rust åº”ç”¨ç¨‹åºæ‰€éœ€çš„ç¨‹åºé›†åˆçš„ç‰¹å®šç‰ˆæœ¬ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å¢åŠ  WASM ç›®æ ‡ï¼Ÿä¸ºäº†åœ¨ NEAR ä¸Šéƒ¨ç½²æˆ‘ä»¬çš„æ™ºèƒ½å¥‘çº¦ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒç¼–è¯‘æˆ WebAssembly ( `.wasm`æ–‡ä»¶)ã€‚ä¸Šé¢çš„`rustup`å‘½ä»¤ä¸º WebAssembly ç›®æ ‡ä¸‰å…ƒç»„(wasm32-unknown-unknown)å®‰è£…æ ‡å‡†åº“ã€‚åœ¨`rustup`æ–‡æ¡£ä¸Šé˜…è¯»æ›´å¤šå…³äºäº¤å‰ç¼–è¯‘çš„ä¿¡æ¯[ã€‚](https://rust-lang.github.io/rustup/cross-compilation.html)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`key_value_storage`çš„ç›®å½•ï¼Œç„¶ååˆ‡æ¢åˆ°è¯¥ç›®å½•å¹¶åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
cargo init --lib 
```

ç»ˆç«¯ä¸­çš„è¾“å‡ºå°†æ˜¯:

```
Created library package 
```

æ‰“å¼€ç”Ÿæˆçš„é»˜è®¤`Cargo.toml`æ–‡ä»¶ï¼Œåˆ é™¤ç°æœ‰å†…å®¹å¹¶ç²˜è´´ä»¥ä¸‹å†…å®¹:

```
[package]
name = "key_value_storage"
version = "0.1.0"
authors = ["Your Name <Your Email>"]
edition = "2018"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
near-sdk = "3.1.0"

[profile.release]
codegen-units = 1
opt-level = "z"
lto = true
debug = false
panic = "abort"
overflow-checks = true
```

åœ¨ https://doc.rust-lang.org/cargo/reference/manifest.html
çš„[æŸ¥çœ‹æ›´å¤šè´§ç‰©æ¸…å•é”®åŠå…¶å®šä¹‰ä½¿ç”¨`overflow-checks = true`é€‰æ‹©åŠ å…¥å¯¹ç®—æœ¯è¿ç®—çš„é¢å¤–å®‰å…¨æ£€æŸ¥:](https://doc.rust-lang.org/cargo/reference/manifest.html)[https://stackoverflow.com/a/64136471/249801](https://stackoverflow.com/a/64136471/249801)
ä½¿ç”¨`opt-level = "z"`å‘Šè¯‰ Rust ç¼–è¯‘å™¨é’ˆå¯¹å°ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚

æˆ‘ä»¬ç°åœ¨éƒ½å‡†å¤‡å¥½äº†ï¼è¿™å¯ä»¥ç”¨ä½œæ¨¡æ¿å’Œä»»ä½•æœªæ¥é¡¹ç›®çš„èµ·ç‚¹ã€‚

# å†™åˆåŒ

æˆ‘ä»¬å°†åœ¨ Rust ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤( [CRUD](https://en.wikipedia.org/wiki/Create,_read,_update_and_delete) )åç«¯ï¼Œå®ƒåˆ©ç”¨äº† NEAR æä¾›çš„é“¾ä¸Šå­˜å‚¨ã€‚å…³äºè¿‘å‚¨çš„æ›´å¤šä¿¡æ¯å¯ä»¥åœ¨çš„è¿‘æ–‡æ¡£[ä¸­æ‰¾åˆ°ã€‚](https://docs.near.org/docs/concepts/storage-staking)

æˆ‘ä»¬å¯ä»¥ä»ç§»é™¤`lib.rs`ä¸­çš„æ‰€æœ‰ç°æœ‰ä»£ç å¹¶ç²˜è´´ä»¥ä¸‹ä»£ç ç‰‡æ®µå¼€å§‹:

```
use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::{env, near_bindgen};
use near_sdk::collections::UnorderedMap;

near_sdk::setup_alloc!();

// 1\. Main Struct

// 2\. Default Implementation

// 3\. Core Logic

// 4\. Tests
```

åœ¨å¥‘çº¦çš„é¡¶éƒ¨ï¼Œæˆ‘ä»¬éœ€è¦ç”¨`use` [å£°æ˜](https://doc.rust-lang.org/reference/items/use-declarations.html#use-declarations)å¯¼å…¥ä¸€äº›ä»£ç æ¨¡å—ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢å±•å¼€`near_sdk`çš„è¿™äº›éƒ¨åˆ†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨`setup_alloc!()`å®ä»`wee_alloc`æœºç®±ä¸­è®¾ç½®å…¨å±€åˆ†é…å™¨ã€‚åˆ†é…å™¨æ˜¯ Rust ä¸­çš„ç¨‹åºåœ¨è¿è¡Œæ—¶ä»ç³»ç»Ÿè·å–å†…å­˜çš„æ–¹å¼ã€‚`wee_alloc`æ˜¯ä¸€ä¸ªä¸º WebAssembly è®¾è®¡çš„å†…å­˜åˆ†é…å™¨ã€‚å®ƒç”Ÿæˆä¸åˆ°ä¸€åƒå­—èŠ‚çš„æœªå‹ç¼© WebAssembly ä»£ç ã€‚è¿™ä¸ªå®æ˜¯æ ·æ¿ä»£ç çš„ç®€å†™:

```
#[cfg(target_arch = "wasm32")]
#[global_allocator]
static ALLOC: near_sdk::wee_alloc::WeeAlloc<'_> = near_sdk::wee_alloc::WeeAlloc::INIT;
```

ä½ å¯ä»¥é˜…è¯»æ›´å¤šå…³äº[å…¨å±€åˆ†é…å™¨](https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/global-allocators.html)å’Œ [wee_alloc](https://github.com/rustwasm/wee_alloc) çš„å†…å®¹ã€‚

## ä¸»è¦ç»“æ„

åœ¨ç¼–å†™æˆ‘ä»¬çš„æ™ºèƒ½å¥‘çº¦æ—¶ï¼Œæˆ‘ä»¬å°†éµå¾ªä¸€ç§æ¨¡å¼ï¼Œä½¿ç”¨ä¸€ä¸ªç»“æ„(`struct`)å’Œä¸€ä¸ªä¸ä¹‹å…³è”çš„å®ç°(`impl`)ã€‚è¿™æ˜¯ NEAR ä¸Šå¤§å¤šæ•°é“é”ˆåˆåŒä¸­ä½¿ç”¨çš„æ¨¡å¼ã€‚åœ¨`lib.rs`ä¸­çš„è¯„è®º`// 1\. Main Struct`ä¸‹é¢æ·»åŠ ä»¥ä¸‹ä»£ç ç‰‡æ®µ:

```
#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize)]
pub struct KeyValue {
    pairs: UnorderedMap<String, String>,
}
```

æˆ‘ä»¬æœ‰ä¸»ç»“æ„`KeyValue`ï¼Œå®ƒæœ‰ä¸€ä¸ªå­—æ®µ`pairs`ã€‚`pairs`æ˜¯æˆ‘ä»¬ä»`near_sdk::collections`è¿›å£çš„`UnorderedMap`å‹ã€‚ [`UnorderedMap`](https://github.com/figment-networks/datahub-learn/tree/ea1bfad2b6006f7e2413fddbcedb2d689a5a18fd/network-documentation/near/tutorials/docs.rs/near-sdk/3.1.0/near_sdk/collections/struct.UnorderedMap.html) æ˜¯ä¸€ç§æ›´æœ‰æ•ˆåœ°åˆ©ç”¨åº•å±‚åŒºå—é“¾ trie å­˜å‚¨çš„æ•°æ®ç»“æ„ã€‚`near_sdk::collections`å‡ ä¹æ²¡æœ‰æä¾›å…¶ä»–æ–¹å¼æ¥å­˜å‚¨æ•°æ®ã€‚è¦æ›´å¥½åœ°äº†è§£å­˜å‚¨çš„æ‰€æœ‰å¯ç”¨ä½¿ç”¨æ–¹å¼ï¼Œè¯·æŸ¥çœ‹`collections`æ¨¡å—çš„[æ–‡æ¡£](https://docs.rs/near-sdk/3.1.0/near_sdk/collections/index.html)ã€‚

`#[near_bindgen]`å’Œ`#[derive(BorshDeserialize, BorshSerialize)]`æ˜¯å±æ€§ã€‚

ä»€ä¹ˆæ˜¯å±æ€§ï¼Ÿä¸€ä¸ªå£°æ˜æ€§æ ‡è®°ï¼Œç”¨äºå‘è¿è¡Œæ—¶ä¼ é€’æœ‰å…³å„ç§å…ƒç´ (å¦‚ç±»ã€æ–¹æ³•ã€ç»“æ„ã€æšä¸¾å™¨ã€ç¨‹åºé›†ç­‰)è¡Œä¸ºçš„ä¿¡æ¯ã€‚

é€šè¿‡æ·»åŠ å®`#[near_bindgen]`,æˆ‘ä»¬ä¸ºç»“æ„`KeyValue`æä¾›äº†ç”Ÿæˆçš„æ ·æ¿ä»£ç ï¼Œä½¿å…¶ä¸åŒºå—é“¾å…¼å®¹ã€‚ç¬¬äºŒä¸ªå®`#[derive(BorshDeserialize, BorshSerialize)]`ååŠ©æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä»¥ä¾¿å°†æ•°æ®å‘é€åˆ° NEAR æˆ–ä» NEAR è·å–æ•°æ®ã€‚

## é»˜è®¤å®ç°

Rust ä¸­çš„æ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€ä¸ª`Default`å®ç°ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬æƒ³ä¸º`keyValue` struct æä¾›æˆ‘ä»¬è‡ªå·±çš„é»˜è®¤å®ç°ã€‚åœ¨`lib.rs`ä¸­çš„è¯„è®º`// 2\. Default Implementation`ä¸‹é¢æ·»åŠ ä»¥ä¸‹ä»£ç ç‰‡æ®µ:

```
impl Default for KeyValue {
    fn default() -> Self {
        Self {
            pairs: UnorderedMap::new(b"r".to_vec())
        }
    }
}
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥:é¦–å…ˆï¼Œæˆ‘ä»¬æ­£åœ¨ä¸º`KeyValue`åˆ›å»ºä¸€ä¸ª`Default`å®ç°ã€‚ä¹‹åï¼Œæˆ‘ä»¬åœ¨è¿”å›`Self`çš„å®ç°ä¸­æ·»åŠ äº†`default`æ–¹æ³•ã€‚`Self`æŒ‡å½“å‰ç±»å‹ï¼Œå³`KeyValue`ã€‚æœ€åï¼Œæˆ‘ä»¬å°†è¿”å›ä¸€ä¸ªæ–°çš„æ— åºåœ°å›¾`Self`ã€‚åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„æ— åºæ˜ å°„æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å°† ID ä½œä¸º`Vec<u8>`ç±»å‹ä¼ é€’ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨`to_vec()`å‡½æ•°å°†ä½œä¸ºå­—èŠ‚å­—ç¬¦ä¸²çš„`b"r"`è½¬æ¢ä¸º`Vec<u8>`ã€‚å‰ç¼€`b`ç”¨äºæŒ‡å®šæˆ‘ä»¬æƒ³è¦çš„å­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ç»„ã€‚ä½ å¯ä»¥åœ¨ Rust æ–‡æ¡£ä¸­é˜…è¯»å­—èŠ‚å­—ç¬¦ä¸²æ–‡å­—[ã€‚](https://doc.rust-lang.org/reference/tokens.html#byte-string-literals)

## æ ¸å¿ƒé€»è¾‘

ç°åœ¨æˆ‘ä»¬è¦ç»™`KeyValue`ç»“æ„æ·»åŠ æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•æ˜¯æˆ‘ä»¬æ™ºèƒ½åˆçº¦çš„æ ¸å¿ƒé€»è¾‘ã€‚åœ¨æ³¨é‡Š`// 3\. Core Logic`ä¸‹æ·»åŠ ä»¥ä¸‹ä»£ç ç‰‡æ®µ:

```
#[near_bindgen]
impl KeyValue {
    pub fn create_update(&mut self, k: String, v: String) {
        env::log(b"created or updated");
        self.pairs.insert(&k, &v);
    }

    pub fn read(&self, k: String) -> Option<String> {
        env::log(b"read");
        return self.pairs.get(&k);
    }

    pub fn delete(&mut self, k: String) {
        env::log(b"delete");
        self.pairs.remove(&k);
    }
}
```

å½“åˆ›å»ºæ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æœ‰ä¸€ä¸ªç”±å…³é”®å­—`impl`å®šä¹‰çš„å®ç°å—ï¼Œåè·Ÿè¦å®ç°çš„`struct`çš„åç§°ã€‚`pub`å…³é”®å­—ä½¿å¾—è¿™äº›æ–¹æ³•å¯ä»¥å…¬å¼€ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥è¢«ä»»ä½•èƒ½å¤Ÿè®¿é—®åè®®å’Œç­¾ç½²äº¤æ˜“çš„äººè°ƒç”¨ã€‚

ç¬¬ä¸€ç§æ–¹æ³•`create_update`ç”¨äºåˆ›å»ºæˆ–æ›´æ–°ç‰¹å®šå¯¹ã€‚å®ƒéœ€è¦ä¸‰ä¸ªå‚æ•°`self`ã€`k`å’Œ`v`ã€‚

æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨`&mut self`å¯å˜åœ°å€Ÿç”¨ selfã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œäº†è§£æ›´å¤šå…³äºå€Ÿæ¬¾çš„ä¿¡æ¯ã€‚

`k`å’Œ`v`æ˜¯æˆ‘ä»¬å°†è¦å­˜å‚¨çš„é”®å€¼ã€‚

`env::log(b"created or updated")`ç”¨äºè®°å½•æ—¥å¿—ã€‚æ—¥å¿—å¯ç”¨äºå‘ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯æ€§æ¶ˆæ¯æˆ–è­¦å‘Šã€‚æ­¤å¤–ï¼Œè¿™äº›æ—¥å¿—åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¸®åŠ©å¼€å‘äººå‘˜ã€‚å½“æˆ‘ä»¬åœ¨æ•™ç¨‹çš„åé¢éƒ¨åˆ†ä¸æ™ºèƒ½åˆåŒäº¤äº’æ—¶ï¼Œæ‚¨å°†åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°è¿™äº›æ—¥å¿—ã€‚ä¸ºæ™ºèƒ½åˆåŒåˆ›å»º web åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨æµè§ˆå™¨çš„å¼€å‘äººå‘˜æ§åˆ¶å°ä¸­æŸ¥çœ‹æ—¥å¿—ã€‚

ä¹‹åï¼Œæˆ‘ä»¬åœ¨`self.pairs`ä¸Šè°ƒç”¨æ–¹æ³•`insert`ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªé”®-å€¼å¯¹(å¦‚æœè¿˜æ²¡æœ‰),å¦åˆ™å®ƒå°†æ›´æ–°ä¸ç»™å®šé”®å…³è”çš„å€¼ã€‚

æ¥ä¸‹æ¥çš„ä¸¤ä¸ªæ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰è°ƒç”¨`insert`æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ self.pairs ä¸Šçš„`get`å’Œ`remove`æ–¹æ³•æ¥è¯»å–æˆ–ç§»é™¤é”®-å€¼å¯¹ã€‚

# æµ‹è¯•åˆåŒ

æˆ‘ä»¬çš„ CRUD æ™ºèƒ½å¥‘çº¦çš„ä»£ç ç°åœ¨å·²ç»å®Œæˆã€‚Rust çš„ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§æ˜¯å®ƒå…è®¸å†…åµŒçš„å•å…ƒæµ‹è¯•ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ä¸åˆåŒç›¸åŒçš„æºæ–‡ä»¶ä¸­ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œ`lib.rs`ï¼ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬åº”è¯¥ä¸ºæ™ºèƒ½å¥‘çº¦ç¼–å†™å•å…ƒæµ‹è¯•ï¼Ÿå•å…ƒæµ‹è¯•æ˜¯è½¯ä»¶å¼€å‘ä¸­çš„å¸¸è§å®è·µã€‚åœ¨ç¼–å†™æ™ºèƒ½åˆçº¦æ—¶ï¼Œå•å…ƒæµ‹è¯•éå¸¸é‡è¦ï¼Œå› ä¸ºæ™ºèƒ½åˆçº¦é€šå¸¸æ˜¯ä¸å¯å˜çš„ï¼Œæœ‰æ—¶è¿˜è´Ÿè´£ç®¡ç†èµ„é‡‘ã€‚ç¼–å†™å¥½çš„å•å…ƒæµ‹è¯•æ˜¯å®‰å…¨å¯é çš„æ™ºèƒ½åˆçº¦å¼€å‘çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚

å°†ä»¥ä¸‹ä»£ç å¤åˆ¶å¹¶ç²˜è´´åˆ°`lib.rs`ä¸­çš„æ³¨é‡Š`// 4\. Tests`ä¸‹:

```
#[cfg(not(target_arch = "wasm32"))]
#[cfg(test)]
mod tests {
    use super::*;
    use near_sdk::MockedBlockchain;
    use near_sdk::{testing_env, VMContext};

    fn get_context(input: Vec<u8>, is_view: bool) -> VMContext {
        VMContext {
            current_account_id: "alice_near".to_string(),
            signer_account_id: "bob_near".to_string(),
            signer_account_pk: vec![0, 1, 2],
            predecessor_account_id: "carol_near".to_string(),
            input,
            block_index: 0,
            block_timestamp: 0,
            account_balance: 0,
            account_locked_balance: 0,
            storage_usage: 0,
            attached_deposit: 0,
            prepaid_gas: 10u64.pow(18),
            random_seed: vec![0, 1, 2],
            is_view,
            output_data_receivers: vec![],
            epoch_height: 0,
        }
    }

    // Test 1

    // Test 2

}
```

è¿™æ˜¯æˆ‘ä»¬ç”¨å„ç§å‚æ•°å’Œä¸€ä¸ªæ¨¡æ‹ŸåŒºå—é“¾å»ºç«‹æµ‹è¯•ç¯å¢ƒçš„åœ°æ–¹ã€‚åœ¨è¿‘ SDK æ–‡æ¡£ä¸­é˜…è¯»æœ‰å…³è™šæ‹Ÿæœºç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒ[çš„æ›´å¤šä¿¡æ¯ã€‚](https://docs.rs/near-sdk/3.1.0/near_sdk/struct.VMContext.html)

è®©æˆ‘ä»¬ä¸º`create_update`å’Œ`read`æ–¹æ³•ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•ã€‚å°†ä¸‹é¢çš„ç‰‡æ®µç²˜è´´åˆ°`lib.rs`ä¸­çš„è¯„è®º`// Test 1`ä¸‹é¢:

```
    #[test]
    fn create_read_pair() {
        let context = get_context(vec![], false);
        testing_env!(context);
        let mut contract = KeyValue::default();
        contract.create_update("first_key".to_string(), "hello".to_string());
        assert_eq!(
            "hello".to_string(),
            contract.read("first_key".to_string()).unwrap()
        );
    }
```

é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨`get_context`å‡½æ•°å¹¶å°†å…¶ä¼ é€’ç»™`testing_env!()`å®æ¥åˆ›å»ºä¸€ä¸ª`context`å˜é‡ï¼Œè¯¥å®ä½¿ç”¨ç»™å®šçš„å‚æ•°åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç¯å¢ƒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªå¯å˜çš„`contract`å˜é‡ï¼Œå®ƒå°†ä½¿ç”¨æˆ‘ä»¬åˆšåˆšç¼–å†™çš„å¥‘çº¦ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ª`contract`å˜é‡æ¥è°ƒç”¨æˆ‘ä»¬çš„æµ‹è¯•æ–¹æ³•ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬è°ƒç”¨`create_update`æ–¹æ³•æ¥è®¾ç½®é”®å€¼å¯¹ã€‚é”®å°†æ˜¯`first_key`ï¼Œå€¼å°†æ˜¯`hello`ã€‚åˆ›å»º pair åï¼Œæˆ‘ä»¬è¦æ£€æŸ¥å­˜å‚¨å™¨ä¸­æ˜¯å¦å­˜å‚¨äº†æ­£ç¡®çš„å€¼ã€‚ä¸ºäº†æ£€æŸ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`assert_eq!()`å®ã€‚å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼›æœŸæœ›å€¼å’Œå®é™…å€¼ã€‚

æˆ‘ä»¬å°†ä¼ é€’æœŸæœ›å€¼ä¸º`"hello".to_string()`ï¼Œå¯¹äºå®é™…å€¼ï¼Œæˆ‘ä»¬å°†è°ƒç”¨ read æ–¹æ³•ï¼Œå¹¶å°†`first_key`ä½œä¸ºå‚æ•°ã€‚read æ–¹æ³•è¿”å›ç±»å‹ä¸º`Option<String>`çš„å€¼ï¼Œä½†é¢„æœŸå€¼çš„ç±»å‹ä¸º`String`ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨`unwrap`ä»`Option<String>`ç±»å‹ä¸­å¾—åˆ°`String`ç±»å‹çš„å€¼ã€‚

å¯¹äºæˆ‘ä»¬çš„ç¬¬äºŒä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬å°†å‡è®¾å¯†é’¥ä¸åœ¨å­˜å‚¨ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬è¯•å›¾è¯»å–å¯†é’¥æ—¶ï¼Œåº”è¯¥è¿”å›`None`ã€‚åœ¨æ³¨é‡Š`// Test 2`ä¸‹é¢æ·»åŠ ä»¥ä¸‹ä»£ç :

```
    #[test]
    fn read_nonexistent_pair() {
        let context = get_context(vec![], true);
        testing_env!(context);
        let contract = KeyValue::default();
        assert_eq!(None, contract.read("first_key".to_string()));
    }
```

å°±åƒåœ¨ç¬¬ä¸€ä¸ªæµ‹è¯•ä¸­ä¸€æ ·ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒå’Œ`contract`å˜é‡ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œå¥‘çº¦å˜é‡æ˜¯ä¸å¯å˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ‰“ç®—æ”¹å˜`contract`å˜é‡ã€‚ä¸ºäº†æ£€æŸ¥åœ¨ä½¿ç”¨`contract.read("first_key".to_string())`è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é”®åæ²¡æœ‰è¿”å›ä»»ä½•å€¼ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`assert_eq!()`ã€‚

ç°åœ¨ï¼Œæ˜¯æ—¶å€™æµ‹è¯•æˆ‘ä»¬çš„ä»£ç äº†ã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
cargo test -- --nocapture 
```

åªæœ‰å½“åˆåŒæ­£å¸¸å·¥ä½œæ—¶ï¼Œæµ‹è¯•æ‰ä¼šé€šè¿‡ã€‚å½“æˆ‘ä»¬çš„æ™ºèƒ½åˆçº¦æ­£å¸¸å·¥ä½œæ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```
Finished test [unoptimized + debuginfo] target(s) in 1m 05s
     Running target/debug/deps/key_value_storage-958f616e81cf3269

running 2 tests
test tests::read_nonexistent_pair ... ok
test tests::create_read_pair ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests key_value_storage

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s 
```

# ç¼–åˆ¶åˆåŒ

æ—¢ç„¶æˆ‘ä»¬å·²ç»ç¼–å†™å¹¶æµ‹è¯•äº† Rust smart å¥‘çº¦ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒç¼–è¯‘åˆ° WebAssembly ä¸­ï¼Œä»¥ä¾¿åœ¨ NEAR ä¸Šéƒ¨ç½²ã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤(æ³¨æ„:Windows ç”¨æˆ·å¿…é¡»åˆ†åˆ«æ‰§è¡Œè¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œ`set`ç”¨äºç¯å¢ƒå˜é‡ï¼Œç„¶åæ˜¯`cargo build`å‘½ä»¤):

```
// Linux and macOS users can use these commands:
env 'RUSTFLAGS=-C link-arg=-s' 
cargo build --target wasm32-unknown-unknown --release

// Windows users can use these commands:
set RUSTFLAGS=-C link-arg=-s
cargo build --target wasm32-unknown-unknown --release 
```

æ¥è‡ª`cargo build`çš„è¾“å‡ºå°†æ˜¯ç±»ä¼¼çš„:

```
Compiling near-sdk v3.1.0
Compiling key_value_storage v0.1.0 (/home/xqc/key_value_storage)
Finished release [optimized] target(s) in 1m 00s 
```

æˆ‘ä»¬ç°åœ¨å·²ç»ç”Ÿæˆäº†ä¸€ä¸ªä¼˜åŒ–çš„ WebAssembly æ–‡ä»¶ï¼Œå¯ä»¥éƒ¨ç½²åœ¨ NEAR ä¸Šï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒéƒ¨ç½²åˆ° NEAR testnet ä¸Šã€‚

# éƒ¨ç½²åˆåŒ

é¦–å…ˆï¼Œæ‚¨å¿…é¡»ä½¿ç”¨`near-cli`ç™»å½•æ‚¨çš„å¸æˆ·ã€‚å¥”è·‘

```
near login 
```

è¿™å°†æŠŠæ‚¨é‡å®šå‘åˆ° NEAR walletï¼Œè¯·æ±‚å®Œå…¨è®¿é—®æ‚¨çš„å¸æˆ·ã€‚ä»è¿™é‡Œï¼Œé€‰æ‹©æ‚¨æƒ³è¦è®¿é—®å¯†é’¥çš„å¸æˆ·

[![Near Login](img/806418ec5d53cab7fe6b74369f5393b8.png)](https://camo.githubusercontent.com/f5a2362188dbdac03b7bdee9432cf4c25d61aa055437fe2a9572bafaf235fa3a/68747470733a2f2f692e696d6775722e636f6d2f6377654c5030632e706e67)

ç‚¹å‡»`allow`åï¼Œç³»ç»Ÿä¼šè¦æ±‚æ‚¨è¾“å…¥è´¦æˆ·åç§°ä»¥ç¡®è®¤æˆæƒã€‚

[![Near Login Confirmation](img/a5f6801126a45979064f1065a58884ce.png)](https://camo.githubusercontent.com/ece66565e8ef6482298642bd67a82610d53fe0c99bcab283cfbe5f53fd104a8f/68747470733a2f2f692e696d6775722e636f6d2f443743347255682e706e67)

ä¸€æ—¦å®Œæˆï¼Œæ‚¨ç°åœ¨å°†æŠŠæ‚¨çš„è®¿é—®å¯†é’¥æœ¬åœ°å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º`.near-credentials`çš„éšè—ç›®å½•ä¸­ã€‚è¯¥ç›®å½•ä½äºæ‚¨çš„ä¸»ç›®å½•çš„æ ¹ç›®å½•ä¸‹:

*   `~/.near-credentials` (MAC / Linux)
*   `C:\Users\YOUR_ACCOUNT\.near-credentials` (Windows)

æ¥ä¸‹æ¥ï¼Œç»™æˆ‘ä»¬çš„åˆåŒå‘½åå¬èµ·æ¥æ˜¯ä¸ªå¥½ä¸»æ„ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`near-cli`åˆ›å»ºä¸€ä¸ªå±äºæˆ‘ä»¬ä¸»å¸æˆ·çš„æ–°å¸æˆ·ã€‚

```
near create-account CONTRACT_NAME.ACCOUNT_ID --masterAcount ACCOUNT_ID --initialBalance 10 
```

è¾“å‡ºå°†æ˜¯:

```
Saving key to '/home/xxx/.near-credentials/testnet/CONTRACT_NAME.ACCOUNT_ID.json'
Account CONTRACT_NAME.ACCOUNT_ID.testnet for network "testnet" was created. 
```

> ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨åœ¨ near testnet ä¸Šçš„å½“å‰ *account_id* æ˜¯ **fido.testnet** ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦å°†åˆåŒå‘½åä¸º **dodo** ï¼Œé‚£ä¹ˆæ‚¨å°†æœ€ç»ˆåˆ›å»ºä»¥ä¸‹æ–°çš„ account _ id**dodo . fido . testnet**ï¼Œå®ƒå°†ä»£è¡¨ *contract_id* ã€‚
> 
> `--initialBalance`å¦‚æœçœç•¥å°†é»˜è®¤ä¸ºé™„è¿‘çš„ **100ã€‚åœ¨æœ¬æ•™ç¨‹çš„åé¢ï¼Œ`CONTRACT_ID`å°†å‚è€ƒ`CONTRACT_NAME.ACCOUNT_ID`é˜…è¯»æ›´å¤šå…³äºé™„è¿‘è´¦æˆ·çš„ä¿¡æ¯[åœ¨è¿™é‡Œ](https://nomicon.io/DataStructures/Account.html)**

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°† Rust smart åˆåŒéƒ¨ç½²åˆ° NEARã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤(æ³¨æ„:å°†`YOUR_ACCOUNT_HERE`æ›¿æ¢ä¸ºæ‚¨çš„å¸æˆ·åï¼Œä¾‹å¦‚ã€‚`example.near`):

```
near deploy --wasmFile target/wasm32-unknown-unknown/release/key_value_storage.wasm --accountId CONTRACT_ID 
```

éƒ¨ç½²å®Œæˆåï¼Œæ‚¨å°†åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡º:

```
Starting deployment. Account id: CONTRACT_ID, node: https://rpc.testnet.near.org, helper: https://helper.testnet.near.org, file: target/wasm32-unknown-unknown/release/key_value_storage.wasm
Transaction Id E4uT8wV5uXSgsJpB73Uox27iPgXztWfL3b5gzxfA3fHo
To see the transaction in the transaction explorer, please open this url in your browser
https://explorer.testnet.near.org/transactions/E4uT8wV5uXSgsJpB73Uox27iPgXztWfL3b5gzxfA3fHo
Done deploying to CONTRACT_ID 
```

<g-emoji class="g-emoji" alias="tada" fallback-src="https://github.githubassets.cimg/icons/emoji/unicode/1f389.png">ğŸ‰</g-emoji> <g-emoji class="g-emoji" alias="tada" fallback-src="https://github.githubassets.cimg/icons/emoji/unicode/1f389.png">ğŸ‰</g-emoji>æˆ‘ä»¬å·²ç»æˆåŠŸéƒ¨ç½²äº†é¦–ä¸ª Rust smart åˆåŒã€‚

# ä¸åˆåŒäº’åŠ¨

ç°åœ¨æˆ‘ä»¬å·²ç»éƒ¨ç½²äº†æˆ‘ä»¬çš„å¥‘çº¦ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ NEAR CLI ä¸å®ƒè¿›è¡Œäº¤äº’ã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œç„¶åè¯»å–å®ƒã€‚

è¯¥å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹:

```
near call CONTRACT_ID create_update '{"k": "first_key", "v" : "1"}' --accountId ACCOUNT_ID 
```

è¾“å‡ºå°†æ˜¯:

```
Scheduling a call: CONTRACT_ID.create_update({"k": "first_key", "v" : "1"})
Receipt: 6bCmuWuAbdiXWvPaTvidbJP4f3mSG4UVcE52g18ZWMq5
        Log [CONTRACT_ID]: created or updated
Transaction Id AQWwThAtXWhU7HJsuD5bvi2FXHpnw5xbj5SEe94Q3MTp
To see the transaction in the transaction explorer, please open this URL in your browser
https://explorer.testnet.near.org/transactions/AQWwThAtXWhU7HJsuD5bvi2FXHpnw5xbj5SEe94Q3MTp
'' 
```

å‡½æ•°å‚æ•°å¿…é¡»ä½œä¸º JSON å­—ç¬¦ä¸²åœ¨æ–¹æ³•åä¹‹åæä¾›ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¯»å–ç¬¬ä¸€ä¸ªé”®çš„å€¼:

```
near view CONTRACT_ID read '{"k": "first_key"}' --accountId ACCOUNT_ID 
```

è¾“å‡ºå°†æ˜¯:

```
View call: CONTRACT_ID.read({"k": "first_key"})
Log [CONTRACT_ID]: read
'1' 
```

> ç”±äº`read`æ–¹æ³•ä¸ä¼šæ”¹å˜æˆ‘ä»¬å¥‘çº¦çš„çŠ¶æ€ï¼Œæˆ‘ä»¬åº”è¯¥ç”¨`view`ä»£æ›¿`call`ã€‚è¿™æ ·åšæœ‰ä»¥ä¸‹ä¼˜ç‚¹:
> 
> *   æˆ‘ä»¬ä¸éœ€è¦æ”¯ä»˜ä»»ä½•è´¹ç”¨
> *   å¯¹æˆ‘ä»¬æŸ¥è¯¢çš„å“åº”å‡ ä¹æ˜¯ç«‹å³å‡ºç°çš„

æœ€åï¼Œæˆ‘ä»¬å°†åˆ é™¤å¯†é’¥:

```
near call CONTRACT_ID delete '{"k": "first_key"}' --accountId ACCOUNT_ID 
```

è¾“å‡ºå°†æ˜¯:

```
Scheduling a call: CONTRACT_ID.delete({"k": "first_key"})
Receipt: wp8YoFZC7CKUNty66VoYuaHMVej7UqcbLcK2FjpMZzk
        Log [CONTRACT_ID]: delete
Transaction Id A4aDmpkfbEP8JwM5KspUiWe1zYnKgUnA5wosCiQBwour
To see the transaction in the transaction explorer, please open this url in your browser
https://explorer.testnet.near.org/transactions/A4aDmpkfbEP8JwM5KspUiWe1zYnKgUnA5wosCiQBwour
'' 
```

# ç»“è®º

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†ä½¿ç”¨ Rust è¿›è¡Œæ¥è¿‘æ™ºèƒ½åˆçº¦ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†â€”â€”åŒ…æ‹¬ Rust æ™ºèƒ½åˆçº¦çš„ç»“æ„ï¼›NEAR SDK æä¾›çš„å‡½æ•°å’Œå®çš„ä½¿ç”¨ï¼›å¦‚ä½•ä½¿ç”¨é“¾ä¸Šå­˜å‚¨ï¼›ç”Ÿé”ˆå¥‘çº¦çš„å•å…ƒæµ‹è¯•ï¼›ç¼–è¯‘å’Œéƒ¨ç½² WebAssemblyï¼Œæœ€åä½¿ç”¨ NEAR CLI ä¸åŒºå—é“¾é™„è¿‘éƒ¨ç½²çš„ Rust å¥‘çº¦è¿›è¡Œäº¤äº’ã€‚

æ„Ÿè°¢æ‚¨è·Ÿéšæœ¬æ•™ç¨‹ï¼Œç°åœ¨å¸¦ç€è¿™äº›çŸ¥è¯†ï¼Œåœ¨ NEAR ä¸Šåˆ›é€ æƒŠäººçš„ä¸œè¥¿å§ï¼

# å…³äºä½œè€…

æœ¬æ•™ç¨‹ç”± [Nikhil Bhintade](https://www.linkedin.com/in/nikbhintade) åˆ›ä½œã€‚ä¸€ä¸ªæƒ³è¦è®°å½•ä»–æ‰€å­¦åˆ°çš„ä¸œè¥¿çš„å¯†ç çˆ±å¥½è€…ã€‚ä½ å¯ä»¥åœ¨ [Github](https://github.com/nikbhintade) ä¸Šä¸ä½œè€…å–å¾—è”ç³»ã€‚