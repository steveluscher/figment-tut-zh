# å®æ–½ğŸ§©

> åŸæ–‡ï¼š<https://github.com/figment-networks/learn-tutorials/blob/master/mirror/02-connect-wallet.md>

ä»»ä½• dApp çš„ç¬¬ä¸€æ­¥éƒ½æ˜¯å»ºç«‹ä¸€ç§è¿æ¥åˆ°ç”¨æˆ·é’±åŒ…çš„æ–¹å¼ã€‚è¿™å…è®¸ dApp åœ¨ä¸ä½¿ç”¨ä¼ ç»Ÿå¯†ç çš„æƒ…å†µä¸‹è®¤è¯ç”¨æˆ·ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè¿™å°†å…è®¸ dApp è·å–ç”¨æˆ·çš„ onchain æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ„å»ºç”¨æˆ·ç‰¹å®šçš„ dApp ä½“éªŒã€‚

{% sidenote title="Box 2.1:å…³äºåŠ å¯†é’±åŒ…çš„è¯´æ˜" %}åŠ å¯†é’±åŒ…æ˜¯ç”¨æˆ·ä¸åŒºå—é“¾åè®®äº¤äº’çš„ç½‘å…³ã€‚é’±åŒ…åœ¨æœ¬åœ°å­˜å‚¨ç”±å¯†ç åŠ å¯†çš„ç”¨æˆ·ç§é’¥ï¼Œå¹¶å…è®¸ç”¨æˆ·ç­¾ç½²äº¤æ˜“ï¼Œä»¥æ— ä¿¡ä»»çš„æ–¹å¼è¯æ˜å¯¹è´¦æˆ·å¯†é’¥çš„æ§åˆ¶ã€‚å¼€å‘äººå‘˜å¯ä»¥åˆ©ç”¨è¿™é¡¹æŠ€æœ¯å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶æ„å»ºåº”ç”¨ç¨‹åºï¼Œè®©ç”¨æˆ·ä»¥å¯ç§»æ¤çš„æ–¹å¼æ§åˆ¶è‡ªå·±çš„æ•°æ®ã€‚è¦æ›´æ·±å…¥åœ°äº†è§£é’±åŒ…ï¼Œè¯·æŸ¥çœ‹[ç´¢æ‹‰çº³é’±åŒ…](https://learn.figment.io/tutorials/solana-wallet-intro)æ•™ç¨‹ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªåä¸º [ethers.js](https://docs.ethers.io/) çš„ JavaScript åº“æ¥ä¸ç”¨æˆ·çš„æµè§ˆå™¨æ‰©å±•é’±åŒ…(å¦‚ MetaMask)è¿›è¡Œäº¤äº’ã€‚è¿™å°†å…è®¸æˆ‘ä»¬æ£€æµ‹æ˜¯å¦å®‰è£…äº†é’±åŒ…ï¼Œå¹¶è®¿é—®ç”¨æˆ·å¸æˆ·çš„ API ä»¥è·å–å…¶æ•°æ®å¹¶åˆ©ç”¨å…¶åŠŸèƒ½ã€‚

æ‰§è¡Œä»»ä½•åŒºå—é“¾æ“ä½œçš„ç¬¬ä¸€æ­¥é€šå¸¸æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªè¿æ¥ã€‚è¿™å¯ä»¥é€šè¿‡ ethers.js ä¸­çš„ **Providers** ç±»æ¥å®ç°ã€‚Web 3 provider å¯¹è±¡åŒ…å«ä»åè®®ä¸­è¯»å–çš„åŠŸèƒ½ã€‚

å¦‚æœæ‚¨ç†Ÿæ‚‰ React å¼€å‘ï¼Œæ‚¨å¯èƒ½ä¼šçŒœåˆ°æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥åœ¨è¿æ¥åˆ° wallet åä¿å­˜åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä¸å¿…åœ¨æ¯æ¬¡å‘ˆç°é¡µé¢æ—¶è®©ç”¨æˆ·é‡æ–°è¿æ¥ä»–ä»¬çš„é’±åŒ…ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ React çš„[ä¸Šä¸‹æ–‡](https://reactjs.org/docs/context.html)ã€‚

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªä¸Šä¸‹æ–‡æä¾›è€…(ä¸è¦ä¸ Web 3 æä¾›è€…æ··æ·†ï¼)æˆ‘ä»¬åœ¨`context/web3Context.tsx`ä¸­å†…ç½®äº†æˆ‘ä»¬çš„æ¨¡æ¿ã€‚

å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹ Web3Provider å‡½æ•°ï¼Œè¯·æ³¨æ„æˆ‘ä»¬ä½¿ç”¨äº† ethers.js **Web3Provider** çš„ç®€å•å®ç°:

```
const provider =
    typeof window == 'undefined' || !window.ethereum
      ? null
      : new ethers.providers.Web3Provider(window.ethereum);
```

å…³æ³¨æœ€åä¸€è¡Œï¼Œæ³¨æ„æˆ‘ä»¬æ­£åœ¨åŸºäº`window.ethereum`å®ä¾‹åŒ–ä¸€ä¸ªæä¾›è€…ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯ç”±å…ƒæ©ç æä¾›çš„[ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ å…¥æ¥å®ä¾‹åŒ–æˆ‘ä»¬çš„ Web 3 provider å¯¹è±¡ã€‚å‰©ä¸‹çš„ä»£ç åªæ˜¯æ£€æŸ¥å…ƒæ©ç æ‰©å±•æ˜¯å¦å­˜åœ¨ï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰ï¼ŒdApp ä»ç„¶ä¼šè¿è¡Œã€‚](https://docs.metamask.io/guide/ethereum-provider.html)

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª Web 3 æä¾›è€…ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æä¾›è€…çš„`send`æ–¹æ³•æ¥è¯·æ±‚ä¸æˆ‘ä»¬æƒ³è¦è¿æ¥çš„é’±åŒ…ç›¸å…³è”çš„è´¦æˆ·(äº†è§£ä¸€ä¸‹[åˆ†å±‚ç¡®å®šæ€§é’±åŒ…](https://docs.ethers.io/v5/api/utils/hdnode/)æ˜¯å¦‚ä½•å·¥ä½œçš„æ˜¯å¾ˆå¥½çš„)ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ª**ç­¾åè€…**å¯¹è±¡ï¼Œå®ƒå°†å…è®¸æˆ‘ä»¬è®¿é—®å…è®¸æˆ‘ä»¬æ”¹å˜åŒºå—é“¾çŠ¶æ€çš„å‡½æ•°ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª`connect`å‡½æ•°ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æä¾›è€…æ˜¯å¦å­˜åœ¨ï¼Œç„¶ååº”è¯¥è·å–æˆ‘ä»¬ç”¨æˆ·çš„å…¬å…±åœ°å€ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª React é’©å­:`setAddress`å°†å…¶è®¾ç½®ä¸º app çŠ¶æ€ã€‚æˆ‘ä»¬åŒ…å«äº†å¯¹ chainId çš„æ£€æŸ¥ï¼Œä»¥ç¡®ä¿ç”¨æˆ·è¿æ¥åˆ° Mumbai testnetâ€”â€”æ¯ä¸ªåŒºå—é“¾ç½‘ç»œéƒ½ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„é“¾æ ‡è¯†ç¬¦ï¼Œä»¥é˜²æ­¢ä¸€ä¸ªåŒºå—é“¾çš„äº‹åŠ¡åœ¨å¦ä¸€ä¸ªä¸Šé‡æ”¾ã€‚æ­¤å¤–ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰å®‰è£…å…ƒæ©ç ï¼Œå®ƒåº”è¯¥æé†’ä»–ä»¬å®‰è£…å®ƒã€‚

æˆ‘ä»¬å¯ä»¥ç”¨å››è¡Œç®€å•çš„ä»£ç æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è¯·æ±‚å…ƒæ©ç æä¾›ç¨‹åºä¸­å¯ç”¨çš„å¸æˆ·ã€‚ç„¶åï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªç­¾åè€…ï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬æä¾›è·å–ç”¨æˆ·å½“å‰åœ°å€å’Œ chainId çš„æ–¹æ³•ã€‚

```
await provider.send('eth_requestAccounts', []);
const signer = provider.getSigner();
const currentAddress = await signer.getAddress();
const chainId = await signer.getChainId();
```

{% sidenote title="Box 2.2:å¦‚æœæ²¡æœ‰ä¸­å¤®æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°†è¿æ¥åˆ°ä»€ä¹ˆï¼Ÿ"%}æ·±å…¥ç ”ç©¶ä»¥å¤ªåŠè™šæ‹Ÿæœºè¶…å‡ºäº†æœ¬æ•™ç¨‹çš„èŒƒå›´ï¼Œä½†æ˜¯å¦‚æœæ‚¨æƒ³æ›´å¥½åœ°äº†è§£æ‚¨æ­£åœ¨æ„å»ºçš„åç«¯ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯è‡³å…³é‡è¦çš„ã€‚æˆ‘ä»¬ä¸æ˜¯è¿æ¥åˆ°ç‰¹å®šçš„æœåŠ¡å™¨å¹¶ä»æ•°æ®åº“ä¸­è¯»å–ï¼Œè€Œæ˜¯ä»åˆ†å¸ƒå¼çŠ¶æ€æœºä¸­è¯»å–ã€‚å®ƒä¹‹æ‰€ä»¥æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ˜¯å› ä¸ºä¸–ç•Œä¸Šæœ‰å¾ˆå¤šèŠ‚ç‚¹æ‹¥æœ‰ç›¸åŒçš„çŠ¶æ€ã€‚å®ƒæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå› ä¸ºå®ƒåœ¨ä»»ä½•æ—¶å€™éƒ½å¤„äºä¸€ä¸ªçŠ¶æ€ã€‚æˆ‘ä»¬ä¸å®ƒäº¤äº’ï¼Œå¹¶ä¸ä½¿ç”¨å®ƒçš„å…¶ä»–äººç«äº‰æ¥æ›´æ–°å®ƒçš„çŠ¶æ€ç‰‡æ®µï¼Œè¿™äº›ç‰‡æ®µå°†åœ¨ä¸‹ä¸€ä¸ªçŠ¶æ€æ›´æ–°å‘¨æœŸä¹‹å‰è¢«è®°å½•ã€‚ä¸è¦æ··æ·† EVM çš„çŠ¶æ€å’Œ React åº”ç”¨çš„çŠ¶æ€ï¼Œå®ƒä»¬æ˜¯ç›¸ä¼¼çš„æ¦‚å¿µï¼Œä½†ä¸æ˜¯ä¸€å›äº‹ï¼

å°†è¿™å››è¡Œä¸æˆ‘ä»¬çš„`connect`åŠŸèƒ½æ”¾åœ¨ä¸€èµ·ï¼Œå¹¶äº†è§£æˆ‘ä»¬çš„è‡ªå®šä¹‰æŒ‚é’©å·²ç»åœ¨ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·ç°åœ¨åº”è¯¥èƒ½å¤Ÿé€šè¿‡ç‚¹å‡»å³ä¸Šè§’çš„**è¿æ¥é’±åŒ…**æŒ‰é’®è¿›è¡Œè¿æ¥ã€‚

[![Forget logins, now our users can connect to our app with their wallets!](img/65f095fd762551210f7eb3474ec3aa2b.png)](https://raw.githubusercontent.com/figment-networks/learn-tutorials/master/mirror/assets/wallet.gif)

{% label %}å¿˜è®°ç™»å½•ï¼Œç°åœ¨æˆ‘ä»¬çš„ç”¨æˆ·å¯ä»¥ç”¨ä»–ä»¬çš„é’±åŒ…è¿æ¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼

##### *æ¸…å• 2.1:è¿æ¥é’±åŒ…çš„ä»£ç *

```
const connect = useCallback(async () => {
  if (provider) {
    await provider.send('eth_requestAccounts', []);
    const signer = provider.getSigner();
    const currentAddress = await signer.getAddress();
    const chainId = await signer.getChainId();

    if (chainId != (80001 as number)) {
      alert('Please connect to the Polygon Mumbai testnet in MetaMask!')
    }

    setAddress(currentAddress);
  } else {
    alert('Please install MetaMask at https://metamask.io');
  }
}, [provider]);
```

# æŒ‘æˆ˜<g-emoji class="g-emoji" alias="weight_lifting" fallback-src="https://github.githubassets.cimg/icons/emoji/unicode/1f3cb.png">ğŸ‹ï¸</g-emoji>

åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­å¯¼èˆªåˆ°`context/web3Context.tsx`ï¼ŒæŒ‰ç…§æ³¨é‡Šä¸­åŒ…å«çš„æ­¥éª¤å®Œæˆ`Web3Provider`å‡½æ•°çš„ç¼–å†™ã€‚æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæè¿°ï¼Œä»¥åŠä¸€ä¸ªé“¾æ¥ï¼Œé“¾æ¥åˆ°æ‚¨ä¸ºäº†å®ç°æ¯ä¸€è¡Œè€Œéœ€è¦æŸ¥çœ‹çš„æ–‡æ¡£ã€‚ç›¸å…³çš„ä»£ç å—ä¹ŸåŒ…å«åœ¨ä¸‹é¢çš„**æ¸…å• 2.2** ä¸­ã€‚

##### *æ¸…å• 2.2:è¿æ¥é’±åŒ…çš„è¯´æ˜*

```
const connect = useCallback(async () => {
  if (provider) {
    // Request accounts, get signer, signers address & chainId
    // More information can be found at https://docs.ethers.io/v5/getting-started/#getting-started--connecting

    const currentAddress = '';
    const chainId = 0;

    if (chainId != (80001 as number)) {
      alert('Please connect to the Polygon Mumbai testnet in MetaMask!')
    }

    // Read more about React hooks: https://reactjs.org/docs/hooks-intro.html
    // The setAddress React hook sets the value of address in the app state
    setAddress(currentAddress);
  } else {
    alert('Please install MetaMask at https://metamask.io');
  }
}, [provider]);
```

å®Œæˆä»£ç åï¼Œæ‚¨ä¼šæƒ³è¦å°è¯•é€šè¿‡ç‚¹å‡»å±å¹•å³ä¸Šè§’çš„**è¿æ¥é’±åŒ…**æŒ‰é’®æ¥è¿æ¥æ‚¨çš„ MetaMask é’±åŒ…:

[![Screenshot of connecting wallet](img/5022aedfe385d5f010eab008bf593dfd.png)](https://raw.githubusercontent.com/figment-networks/learn-tutorials/master/mirror/assets/connect.jpg)